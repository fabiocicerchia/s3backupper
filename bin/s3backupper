#!/bin/bash

DEEP_INTEGRITY_CHECK=0
VERBOSE=0

source conf/aws

while getopts ":dvh" opt; do
  case ${opt} in
    d )
      DEEP_INTEGRITY_CHECK=1
      ;;
    v )
      VERBOSE=1
      ;;
    h )
      echo "Usage: $0 [-h] [-dv]"
      echo -e "\nOptions:\n"
      echo "-d   Enable Deep Integrity Checks."
      echo "     Since it has to download all data files in the repository,"
      echo "     beware that it might incur higher bandwidth costs than usual"
      echo "     and also that it takes more time than the default check."
      echo "     (default: off)"
      echo "-v   Verbose."
      echo "-h   Help."
      exit 0
      ;;
  esac
done

echo "### BACKUPPING FILES"
VERBOSE_FLAG=""
if [ $VERBOSE -eq 1 ]; then
    VERBOSE_FLAG="--verbose"
fi
for ITEM in $(cat conf/files); do
    echo "> Backupping '$ITEM'..."
    restic -r s3:s3.amazonaws.com/$bucket $VERBOSE_FLAG backup $ITEM
done

echo "### INTEGRITY CHECKS"
CHECK_FLAG=""
if [ $DEEP_INTEGRITY_CHECK -eq 1 ]; then
    CHECK_FLAG="--read-data"
fi
restic -r s3:s3.amazonaws.com/$bucket $VERBOSE_FLAG check $CHECK_FLAG
